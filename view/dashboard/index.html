<!DOCTYPE html>

<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Dashboard â€” The Accessibility Machine</title>

  <style>
    <%= css.common %>

    body {
      margin: 0;
      padding: 0;
      text-align: center;
    }

    header {
      padding: 3em 0 2em 0;
      background: url('https://www.liip.ch/bundles/liipchcore/img/slashpattern_big.jpg');
    }

    h1 {
      color: #fff;
      font-weight: bold;
    }

    table {
      display: inline-table;
      margin: 0 auto;
      border-spacing: 3em 1em;
    }

    a {
      display: inline-block;
      overflow: hidden;
      text-indent: -9999px;
      width: 2em;
      height: 2em;
      border-radius: 50%;
      background: rgb(244, 96, 37) url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIiB2ZXJzaW9uPSIxLjEiIHg9IjBweCIgeT0iMHB4IiB2aWV3Qm94PSIwIDAgMTAwIDEyNSIgZW5hYmxlLWJhY2tncm91bmQ9Im5ldyAwIDAgMTAwIDEwMCIgeG1sOnNwYWNlPSJwcmVzZXJ2ZSI+PHBhdGggZmlsbD0iI2ZmZmZmZiIgZD0iTTQ5Ljk3NiwyMC4wMjRjLTI5LjM4NywwLTQ1LjA3MSwyNC42ODItNDUuMDcxLDI5LjQ3OXMxNS42ODQsMjkuNDgsNDUuMDcxLDI5LjQ4ICBzNDUuMDcxLTI0LjY4Myw0NS4wNzEtMjkuNDhTNzkuMzYzLDIwLjAyNCw0OS45NzYsMjAuMDI0eiBNNDkuOTc2LDc0Ljk4NGMtMjcuMDg1LDAtNDAuODM0LTIyLjQyNy00MS4wNzEtMjUuNDU3ICBjMC4yMzctMy4wNzcsMTMuOTg3LTI1LjUwMyw0MS4wNzEtMjUuNTAzYzI3LjA4NCwwLDQwLjgzNCwyMi40MjYsNDEuMDcxLDI1LjQ1NkM5MC44MSw1Mi41NTgsNzcuMDYxLDc0Ljk4NCw0OS45NzYsNzQuOTg0eiIvPjxwYXRoIGZpbGw9IiNmZmZmZmYiIGQ9Ik00OS45NjcsMzMuMDA1Yy05LjM2MywwLTE2Ljk4LDcuNDExLTE2Ljk4LDE2LjUxOWMwLDkuMTA5LDcuNjE3LDE2LjUyMSwxNi45OCwxNi41MjEgIHMxNi45ODEtNy40MTEsMTYuOTgxLTE2LjUyMUM2Ni45NDgsNDAuNDE2LDU5LjMzLDMzLjAwNSw0OS45NjcsMzMuMDA1eiBNNDkuOTY3LDYyLjA0NWMtNy4xNTcsMC0xMi45OC01LjYxNy0xMi45OC0xMi41MjEgIGMwLTYuOTAzLDUuODIzLTEyLjUxOSwxMi45OC0xMi41MTljNy4xNTgsMCwxMi45ODEsNS42MTYsMTIuOTgxLDEyLjUxOUM2Mi45NDgsNTYuNDI4LDU3LjEyNSw2Mi4wNDUsNDkuOTY3LDYyLjA0NXoiLz48L3N2Zz4=') no-repeat .25em .28em;
      background-size: 1.5em;
    }

    svg {
      display: block;
      margin: 0 auto 2em auto;
      max-height: 50vh;
      max-width: 800px;
      background: #fff;
    }

    svg text {
      text-anchor: start;
      dominant-baseline: central;
      transform: translate(.7em);
    }
  </style>

  <script>
    function GET(url, onComplete) {
        var request = new XMLHttpRequest();
        request.addEventListener('load', onComplete);
        request.open('GET', url);
        request.responseType = 'json';
        request.send();
    }

    function buildListing (data) {
        var tbody = document.querySelector('#listing tbody');

        Object
            .keys(data)
            .sort(
                function (a, b) {
                    return new Date(data[b].date) - new Date(data[a].date);
                }
            )
            .forEach(
                function (key) {
                    var report      = data[key];
                    var tr          = document.createElement('tr');
                    var tdDate      = document.createElement('td');
                    var dateOptions = {
                        weekday: 'long',
                        year   : 'numeric',
                        month  : 'long',
                        day    : 'numeric',
                        hour   : 'numeric',
                        minute : 'numeric'
                    };
                    var date               = new Date(report.date).toLocaleDateString('en-GB', dateOptions)
                    tdDate.innerHTML       = date;
                    var tdStatistics       = document.createElement('td');
                    tdStatistics.innerHTML =
                        'errors  : ' + report.errorCount + ', ' +
                        'warnings: ' + report.warningCount + ', ' +
                        'notices : ' + report.noticeCount;
                    var tdLink       = document.createElement('td');
                    tdLink.innerHTML =
                        '<a href="/report/' +
                        report.reportDirectory +
                        '/index.html" target="_blank">See report from ' + date + '</a>';

                    tr.appendChild(tdDate);
                    tr.appendChild(tdStatistics);
                    tr.appendChild(tdLink);
                    tbody.appendChild(tr);
                }
            );
    }

    function buildGraph (data) {
        var svgNS        = 'http://www.w3.org/2000/svg';
        var graphHeight  = 400;
        var graphWidth   = 800;
        var marginHeight = 50;
        var marginWidth  = 50;
        var graph        = document.querySelector('#graph');
        graph.setAttribute(
            'viewBox',
            '0 0 ' + (graphWidth + marginWidth) + ' ' + (graphHeight + marginHeight)

        );
        var polylines = document.createElementNS(svgNS, 'g');
        var boundY    = 0;

        Object
            .keys(data)
            .sort(
                function (a, b) {
                    return new Date(data[a].date) - new Date(data[b].date);
                }
            )
            .slice(0, 8)
            .map(
                function (key) {
                    var report = data[key];
                    boundY     = Math.max(
                        boundY,
                        report.errorCount,
                        report.warningCount,
                        report.noticeCount
                    );

                    return key;
                }
            )
            .map(
                function (key, index) {
                    var report = data[key];
                    var x      = 50 + 100 * index;

                    var computeY = function (count) {
                        return Math.round((graphHeight + marginHeight) - ((count * graphHeight) / boundY));
                    };

                    var createPoint = function (cx, cy, type) {
                        var point = document.createElementNS(svgNS, 'circle');
                        point.setAttribute('cx', cx);
                        point.setAttribute('cy', cy);
                        point.setAttribute('r', 5);
                        point.setAttribute('data-result-level', type);

                        return point;
                    };

                    var coordinates = {
                        error  : [x, computeY(report.errorCount)],
                        warning: [x, computeY(report.warningCount)],
                        notice : [x, computeY(report.noticeCount)]
                    };

                    var errorPoint   = createPoint(coordinates.error[0],   coordinates.error[1],   'error');
                    var warningPoint = createPoint(coordinates.warning[0], coordinates.warning[1], 'warning');
                    var noticePoint  = createPoint(coordinates.notice[0],  coordinates.notice[1],  'notice');

                    var group = document.createElementNS(svgNS, 'g');
                    group.appendChild(errorPoint);
                    group.appendChild(warningPoint);
                    group.appendChild(noticePoint);

                    graph.appendChild(group);

                    return coordinates;
                }
            )
            .reduce(
                function (previous, current) {
                    if (null === previous) {
                        return current;
                    }

                    var createLine = function (type) {
                        var line = document.createElementNS(svgNS, 'line');
                        line.setAttribute('x1', previous[type][0]);
                        line.setAttribute('y1', previous[type][1]);
                        line.setAttribute('x2', current[type][0]);
                        line.setAttribute('y2', current[type][1]);
                        line.setAttribute('data-result-level', type);

                        return line;
                    };

                    polylines.appendChild(createLine('error'));
                    polylines.appendChild(createLine('warning'));
                    polylines.appendChild(createLine('notice'));

                    return current;
                },
                null
            );

        graph.appendChild(polylines);
    }

    document.addEventListener(
        'DOMContentLoaded',
        function () {
            GET(
                '/api/statistics/all',
                function () {
                    buildListing(this.response);
                    buildGraph(this.response);
                }
            );
        }
    );
  </script>
</head>

<body>

<header>
  <h1>Dashboard</h1>

  <svg viewBox="0 0 900 500" id="graph">
  </svg>
</header>

<table id="listing">
  <thead>
    <tr>
      <th>Date</th>
      <th>Statistics</th>
      <th><span style="display: none" aria-hidden="true">Links</span></th>
    </tr>
  </thead>
  <tbody>
  </tbody>
</table>

</body>
</html>
